import argparse
from copy import copy

from plugins.Exchange import PluginExchangeBase
from utils.consts import AllPluginTypes
from modules.exchangetool import ExchangeTool


class PluginExchangeEmailContextSearch(PluginExchangeBase):
    display = "邮件内容搜索"
    alias = "ex_em_s"
    p_type = AllPluginTypes.Exploit

    def __init__(self):
        super().__init__()

    def reg_argument(self, parser: argparse.ArgumentParser):
        parser.description = self.display

        parser.add_argument(
            "-d",
            "--domain",
            help="domain name.Format(domain.com)",
            required=True,
            dest="domain",
        )
        parser.add_argument(
            "-u",
            "--username",
            help="username to login",
            required=False,
            dest="username",
        )
        parser.add_argument(
            "-p", "--password", help="password", required=False, dest="password"
        )
        parser.add_argument(
            "-i", "--ip", help="target address", required=False, dest="ip"
        )
        parser.add_argument(
            "-s", "--string", help="search string", required=True, dest="search_string"
        )

    def run_script(self, args) -> dict:
        """
        脚本入口函数
        :return: bool
        """
        result = copy(self.result)

        ex = ExchangeTool(args.domain, args.username, args.password, args.ip)
        ex.search_email_context(args.search_string)

        return result
